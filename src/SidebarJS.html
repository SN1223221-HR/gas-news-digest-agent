<script>
  let allArticles = [];

  window.onload = function() {
    setupDate();
    fetchData();
  };

  function setupDate() {
    const now = new Date();
    document.getElementById('date-display').textContent = now.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
  }

  function fetchData() {
    google.script.run
      .withSuccessHandler(onSuccess)
      .withFailureHandler(onFailure)
      .getNewsFeedData();
  }

  function onSuccess(jsonString) {
    allArticles = JSON.parse(jsonString);
    updateFilterOptions();
    renderFeed();
  }

  function onFailure(e) {
    document.getElementById('feed-container').innerHTML = '<div class="empty">Error: ' + e.message + '</div>';
  }

  function updateFilterOptions() {
    const select = document.getElementById('keyword-filter');
    const keywords = [...new Set(allArticles.map(a => a.keyword))].filter(Boolean);
    keywords.forEach(kw => {
      const option = document.createElement('option');
      option.value = kw;
      option.textContent = kw;
      select.appendChild(option);
    });
  }

  function renderFeed() {
    const container = document.getElementById('feed-container');
    const filterValue = document.getElementById('keyword-filter').value;
    const filtered = filterValue === 'ALL' ? allArticles : allArticles.filter(a => a.keyword === filterValue);

    if (filtered.length === 0) {
      container.innerHTML = '<div class="empty">No articles found.</div>';
      return;
    }

    const html = filtered.map((article, index) => {
      const rating = article.rating || 0;
      // 星のHTML生成 (5つ)
      let starsHtml = '';
      for (let i = 1; i <= 5; i++) {
        const activeClass = i <= rating ? 'active' : '';
        // リンククリックと競合しないよう event.preventDefault を仕込む
        starsHtml += `<span class="star ${activeClass}" onclick="rateArticle(event, '${article.link}', ${i}, this)">★</span>`;
      }

      return `
        <a href="${article.link}" class="card">
          <div class="card-meta">${escapeHtml(article.keyword)}</div>
          <h2 class="card-title">${escapeHtml(article.title)}</h2>
          <div class="card-info">
            <span class="source-tag">${escapeHtml(article.source)}</span>
            <span>${escapeHtml(article.date || '')}</span>
          </div>
          <div class="rating-area">
            ${starsHtml}
          </div>
        </a>
      `;
    }).join('');
    
    container.innerHTML = html;
  }

  // 評価送信処理
  function rateArticle(event, link, rating, starElem) {
    event.preventDefault(); // リンク遷移を止める
    event.stopPropagation();

    // UIの即時反映 (親要素内の全starを取得してクラス付け替え)
    const parent = starElem.parentElement;
    const stars = parent.querySelectorAll('.star');
    stars.forEach((s, idx) => {
      if (idx < rating) s.classList.add('active');
      else s.classList.remove('active');
    });

    // サーバー送信
    google.script.run
      .withFailureHandler(err => console.error(err))
      .updateArticleRating(link, rating);
  }

  function escapeHtml(str) {
    if(!str) return '';
    return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
  }
</script>
