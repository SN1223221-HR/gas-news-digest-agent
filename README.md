# ⚡ News Digest Agent for GAS

**Google Apps Script (GAS)** 上で動作する、プロフェッショナル仕様のニュース収集・配信エージェントです。
Google NewsのRSSを定期的にクローリングし、興味のあるトピックをデータベース（スプレッドシート）に蓄積。指定した時間にまとめてHTMLメールでレポートを送信します。

## 🚀 特徴 (Features)

* **完全サーバーレス**: Google Workspace環境だけで動作し、サーバー管理は不要。
* **堅牢なアーキテクチャ**: Repositoryパターンを採用し、保守性と拡張性を確保。
* **高度な重複排除**: スプレッドシートと `CacheService` を組み合わせたハイブリッドな重複チェック。
* **信頼性**: `LockService` による排他制御と、通信エラー時の自動リトライ（Exponential Backoff）を実装。
* **時限配信システム**: 収集は頻繁に行い、通知は指定した時間（例: 朝7時）にまとめて行う「非同期配信」に対応。
* **UXへの配慮**: スプレッドシート上に専用メニューを追加し、手動操作やテストが容易。

## 🛠 セットアップ (Setup)

### 1. スプレッドシートの準備
新規スプレッドシートを作成し、以下のシート（タブ）を用意してください。

| シート名 | 用途 | 備考 |
| :--- | :--- | :--- |
| **Config** | 設定管理 | A列にキーワード、C/D列に環境設定 |
| **DB** | 記事データ | 1行目に見出しが必要（後述） |
| **Logs** | ログ出力 | 自動生成されますが、手動作成も可 |

#### DBシートのヘッダー (1行目)
以下の通りに入力してください。
`Timestamp`, `Keyword`, `Title`, `URL`, `PubDate`, `Source`, `IsSent`

### 2. Configシートの設定
**A列 (A2以降)** に検索したいキーワードを入力してください。
**C列(Key) / D列(Value)** に以下の設定を入力してください。

| Key (C列) | Value (D列) 例 | 説明 |
| :--- | :--- | :--- |
| `DeliveryHours` | `7, 12, 19` | 配信する時間（カンマ区切り、24時間表記） |
| `Region` | `JP` | ニュースの対象国 (JP, US, GB等) |
| `Language` | `ja` | 言語設定 (ja, en等) |
| `UserName` | `User` | メール本文での呼び名 |

### 3. スクリプトの導入
1. スプレッドシートのメニューから `拡張機能` > `Apps Script` を開く。
2. `server.gs` にコードを貼り付け。
3. 一度 `onOpen` 関数を実行し、権限を承認する。
4. スプレッドシートをリロードすると、メニューバーに `⚡ News Agent` が出現します。

## ⏰ トリガー設定 (Triggers)

Apps Scriptのトリガー設定画面から以下を設定してください。

1.  **収集用 (`crawlTask`)**
    * イベントのソース: 時間主導型
    * タイプ: 時間ベースのタイマー
    * 間隔: **4時間おき** (推奨)

2.  **配信用 (`checkAndSendMailTask`)**
    * イベントのソース: 時間主導型
    * タイプ: 時間ベースのタイマー
    * 間隔: **1時間おき**
    * *※スクリプト内部で `DeliveryHours` をチェックし、該当時間のみ送信します。*

## 🏗 アーキテクチャ (Architecture)

このプロジェクトは、GASの制約内で最大限の保守性を発揮するため、以下のクラス設計を採用しています。

* **NewsApp (Controller)**: アプリケーションのメインフローを制御。
* **SheetRepository**: データの永続化（読み書き）を担当。
* **RssService**: 外部API通信とXMLパース、リトライ処理を担当。
* **MailService**: HTMLメールの生成と送信を担当。
* **UrlCacheService**: `CacheService` を用いた高速な重複チェック。
* **LoggerService**: 構造化されたログの記録。

## 📜 License

[MIT License](LICENSE)
